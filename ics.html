<!DOCTYPE  html>
<head>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <style>
        img {
            width: 99%;
            height: 700px;
        }
    </style>

    <script>

   



    var icsFormatter = function() {
    'use strict';

    if (navigator.userAgent.indexOf('MSIE') > -1 && navigator.userAgent.indexOf('MSIE 10') == -1) {
        //console.log('Unsupported Browser');
        return;
    }

    var SEPARATOR = (navigator.appVersion.indexOf('Win') !== -1) ? '\r\n' : '\n';
    var calendarEvents = [];
    var calendarStart = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0'
    ].join(SEPARATOR);
    var calendarEnd = SEPARATOR + 'END:VCALENDAR';

    return {
        /**
         * Returns events array
         * @return {array} Events
         */
        'events': function() {
            return calendarEvents;
        },

        /**
         * Returns calendar
         * @return {string} Calendar in iCalendar format
         */
        'calendar': function() {
            return calendarStart + SEPARATOR + calendarEvents.join(SEPARATOR) + calendarEnd;
        },

        /**
         * Add event to the calendar
         * @param  {string} subject     Subject/Title of event
         * @param  {string} description Description of event
         * @param  {string} location    Location of event
         * @param  {string} begin       Beginning date of event
         * @param  {string} stop        Ending date of event
         */
        'addEvent': function(subject, description, location, begin, stop) {
            // I'm not in the mood to make these optional... So they are all required
            if (typeof subject === 'undefined' ||
                typeof description === 'undefined' ||
                typeof location === 'undefined' ||
                typeof begin === 'undefined' ||
                typeof stop === 'undefined'
            ) {
                return false;
            }

            //TODO add time and time zone? use moment to format?
            var start_date = new Date(begin);
            var end_date = new Date(stop);

            var start_year = ("0000" + (start_date.getFullYear().toString())).slice(-4);
            var start_month = ("00" + ((start_date.getMonth() + 1).toString())).slice(-2);
            var start_day = ("00" + ((start_date.getDate()).toString())).slice(-2);
            var start_hours = ("00" + (start_date.getHours().toString())).slice(-2);
            var start_minutes = ("00" + (start_date.getMinutes().toString())).slice(-2);
            var start_seconds = ("00" + (start_date.getMinutes().toString())).slice(-2);

            var end_year = ("0000" + (end_date.getFullYear().toString())).slice(-4);
            var end_month = ("00" + ((end_date.getMonth() + 1).toString())).slice(-2);
            var end_day = ("00" + ((end_date.getDate()).toString())).slice(-2);
            var end_hours = ("00" + (end_date.getHours().toString())).slice(-2);
            var end_minutes = ("00" + (end_date.getMinutes().toString())).slice(-2);
            var end_seconds = ("00" + (end_date.getMinutes().toString())).slice(-2);

            // Since some calendars don't add 0 second events, we need to remove time if there is none...
            var start_time = '';
            var end_time = '';
            if (start_minutes + start_seconds + end_minutes + end_seconds !== 0) {
                start_time = 'T' + start_hours + start_minutes + start_seconds;
                end_time = 'T' + end_hours + end_minutes + end_seconds;
            }

            var start = start_year + start_month + start_day + start_time;
            var end = end_year + end_month + end_day + end_time;

           /* var calendarEvent = [
                'BEGIN:VEVENT',
                'CLASS:PUBLIC',
                'DESCRIPTION:' + description,
                'DTSTART;TZID=Australia/Melbourne:' + start,
                'DTEND;TZID=Australia/Melbourne:' + end,
                'LOCATION:' + location,
                'SUMMARY;LANGUAGE=en-us:' + subject,
                'TRANSP:TRANSPARENT',
                'END:VEVENT'
            ].join(SEPARATOR);*/
		
		 var a = document.getElementById("clayton-addresses").checked;
            if(a){
                console.log("melbourne zone forced");
            var calendarEvent = [
                'BEGIN:VEVENT',
                'CLASS:PUBLIC',
                'DESCRIPTION:' + description,
                'DTSTART;TZID=Australia/Melbourne:' + start,
                'DTEND;TZID=Australia/Melbourne:' + end,
                'LOCATION:' + location,
                'SUMMARY;LANGUAGE=en-us:' + subject,
                'TRANSP:TRANSPARENT',
                'END:VEVENT'
            ].join(SEPARATOR);}else{
                console.log("auto time select");
                var calendarEvent = [
                    'BEGIN:VEVENT',
                    'CLASS:PUBLIC',
                    'DESCRIPTION:' + description,
                    'DTSTART:' + start,
                    'DTEND:' + end,
                    'LOCATION:' + location,
                    'SUMMARY;LANGUAGE=en-us:' + subject,
                    'TRANSP:TRANSPARENT',
                    'END:VEVENT'
                ].join(SEPARATOR);
            }

            calendarEvents.push(calendarEvent);
            return calendarEvent;
        },

        /**
         * Download calendar using the saveAs function from filesave.js
         * @param  {string} filename Filename
         * @param  {string} ext      Extention
         */
        'download': function(filename, ext) {
            if (calendarEvents.length < 1) {
                return false;
            }

            ext = (typeof ext !== 'undefined') ? ext : '.ics';
            filename = (typeof filename !== 'undefined') ? filename : 'calendar';
            var calendar = calendarStart + SEPARATOR + calendarEvents.join(SEPARATOR) + calendarEnd;
            window.open( "data:text/calendar;charset=utf8," + escape(calendar));
        }
    };
};

if (typeof define === "function" && define.amd) {
  /* AMD Format */
  define("icsFormatter", [], function() {
    return icsFormatter();
  });
} else if (typeof module === "object" && module.exports) {
  /* CommonJS Format */
  module.exports = icsFormatter();
} else {
  /* Plain Browser Support */
  this.myModule = icsFormatter();
}
</script>
<script>

    function submitfeedback() {
        console.log("GG");
        femail = document.getElementById("femail").value;
        ffeedback = document.getElementById("ffeedback").value;
        /*$.post('http://139.59.98.45/icsallocate/feedback.php', { email: femail, feedback : ffeedback},
                function(returnedData){
                    console.log(returnedData);
                }).fail(function(){
            console.log("error");
        });*/
        $.ajax({
            url: 'http://139.59.98.45/icsallocate/feedback.php',
            type: 'POST',
            data: { email: femail, feedback : ffeedback} ,
            success: function (response) {
                alert(response.status);
            },
            error: function () {
                alert("error");
            }
        });
    }

var buildICSEntry = function( javascriptExampleDateObject ){

    	/*var calEntry = icsFormatter();

    	var title = 'sometitlestring';
    	var place = 'our secret meeting place';
    	var begin = new Date();
    	var end = new Date(begin.getTime() + 30*60000);

    	var description = 'A very long and boring description of what is the agenda of this super exclusiv pow-wow';

		calEntry.addEvent(title,description, place, begin.toUTCString(), begin.toUTCString());
		calEntry.download('ourSecretMeeting');*/
 }

 function make(){
     var calEntry = icsFormatter();

     text = document.getElementById("csvValues").value;

     //check OK
     var data = text.split('\n');


     //data.length OK
     for(i=1; i < data.length; i++){

         var subjectCode,desc,group,activity,day,time,campus,location,staff,duration,dates;
         var arraydata = data[i].split(',');

         //fetch all variables of a row
         subjectCode = arraydata[0];
         desc = arraydata[1];
         group = arraydata[2];
         activity = arraydata[3];
         day = arraydata[4];
         time = arraydata[5];
         campus = arraydata[6];
         location = arraydata[7];
         staff = arraydata[8];
         duration = arraydata[9];
         dates = arraydata[10];

         //constants
         var tab = "\t";
         var newline = "\n";

         //variables check OK
         /*//console.log(subjectCode+ "\n" +desc+ "\n" +group+ "\n" +activity+ "\n" +day+ "\n" +time+
                 "\n" +campus+ "\n" +location+ "\n" +staff+ "\n" +duration+ "\n" +dates+newline+newline);*/


         var title = subjectCode + tab + desc + tab + group + activity ;
         var place = location.substr(0,location.indexOf("/"));

         //title and place OK
//         //console.log(title + newline + place);

         var finalLoc = "";
         /*var locFound = false;
         var locations = locationData.split("\n");

         for(j=0; j < locations.length && !locFound; j++){
             var tempLocation = locations[j].split(" ");
             var pl = tempLocation[0];
             if(place==pl){
                 finalLoc =  tempLocation[1] + " " + tempLocation[2] + " " + tempLocation[3];
                 locFound = true;
             }
         }

         if(!locFound){
             finalLoc=location;
         }*/

	     var claytonStreetNames = {
             All: "Alliance Lane",
             Anc: "Ancora Imparo Way",
             Chn: "Chancellors Walk",
             Col: "College Walk",
             Exh: "Exhibition Walk",
             FGR: "Ferntree Gully Road",
             Inn: "Innovation Walk",
             Rnf: "Rainforest Walk",
             Res: "Research Way",
             Sce: "Scenic Boulevard"
         };

         var locationReplacements = [
             [/Exh\w\//, "Exh/"]
         ];
	     //CREDITS TO MARK'S WEBSITE AT : https://mcpower.github.io/icallate/

         var splitLocation = location.split("/");
         if (splitLocation[0].startsWith("CL_") && claytonStreetNames.hasOwnProperty(splitLocation[0].substr(-3, 3))) {
             location = "Room " + splitLocation[1] + ", " + splitLocation[0].slice(3, -3) + " " + claytonStreetNames[splitLocation[0].substr(-3, 3)];
         }
         finalLoc = location;
         //finalLoc OK
         console.log(finalLoc);

         var year, month, date, hours, minutes, seconds, milliseconds;
         seconds = 0; milliseconds = 0; year = 2017;

         var lessionDates = dates.split(" ");
         for(q=0; q < lessionDates.length; q++){

             if (lessionDates[q].indexOf("-")>=0) {
                 var range = lessionDates[q].split('-');
                 var d, m;
                 var s = range[0].split("/");

//             ('0' + deg).slice(-2)
                 d = ('0' + s[0]).slice(-2);
                 m = ('0' + s[1]).slice(-2);

                 var tData = time.split(":");

                 hours = tData[0];
                 minutes = tData[1];
                 var periodBegin = new Date(year, m - 1, d, hours, minutes, 0, 0);

//             FIT1045_CL_S1_DAY,ALG PROG FUN PYTHON,Laboratory,12,Thu,18:00,CL,CL_14Rnf/146,-,2 hrs,2/3-13/4 27/4-25/5
                 /*BIO1011_CL_S1_DAY,BIOLOGY,Laboratory,53-P1,Wed,14:00,CL,CL_23Rnf/G04_Bay5,-,3 hrs,8/3 22/3 5/4 26/4 10/5
             BIO1011_CL_S1_DAY,BIOLOGY,Laboratory,53-P2,Wed,14:00,CL,CL_23Rnf/G04_Bay5,-,1.5 hrs,1/3 24/5
             BIO1011_CL_S1_DAY,BIOLOGY,Lecture_1,03-P1,Mon,09:00,CL,CL_21Rnf/S7,-,1 hr,27/2-20/3
             BIO1011_CL_S1_DAY,BIOLOGY,Lecture_1,03-P2,Mon,09:00,CL,CL_43Rnf/STH1,-,1 hr,27/3-10/4 24/4-22/5*/
             s = range[1].split("/");

                 var d2, m2;
//             ('0' + deg).slice(-2)
                 d2 = ('0' + s[0]).slice(-2);
                 m2 = ('0' + s[1]).slice(-2);
                 var periodEnd = new Date(year, m2 - 1, d2, 0, 0, 0, 0);
//             var periodEnd = new Date(year,)

                 //console.log(periodBegin, periodEnd);

                 while (periodBegin.getTime() < periodEnd.getTime()) {
                     var dur = duration.getNums();
                     //console.log(dur[0]);
                     var endTime = new Date(periodBegin.getTime() +  dur[0] * 60 * 60 * 1000);

                     var description = campus + " " + desc;


                     calEntry.addEvent(title, description, finalLoc, periodBegin.toUTCString(), endTime.toUTCString());

                     periodBegin = new Date(periodBegin.getTime() + 604800000);
                 }
             }else{
                 s = lessionDates[q].split("/");
                 d2 = ('0' + s[0]).slice(-2);
                 m2 = ('0' + s[1]).slice(-2);

                 var tData = time.split(":");

                 hours = tData[0];
                 minutes = tData[1];
                 periodBegin = new Date(year, m2 - 1, d2, hours, minutes, 0, 0);

                 var dur = duration.getNums();
                 //console.log(dur[0]);
                 var endTime = new Date(periodBegin.getTime() +  dur[0] * 60 * 60 * 1000);

                 var description = campus + " " + desc;


                 calEntry.addEvent(title, description, finalLoc, periodBegin.toUTCString(), endTime.toUTCString());
             }


         }



         /*var begin = new Date();
         var end = new Date(begin.getTime() + 30*60000);

         var description = 'A very long and boring description of what is the agenda of this super exclusiv pow-wow';

         calEntry.addEvent(title,description, place, begin.toUTCString(), begin.toUTCString());*/

     }
     calEntry.download('MonashTT');


//     calEntry.download('ourSecretMeeting');
 }

String.prototype.getNums= function(){
    var rx=/[+-]?((\.\d+)|(\d+(\.\d+)?)([eE][+-]?\d+)?)/g,
            mapN= this.match(rx) || [];
    return mapN.map(Number);
};

 function findLocation(place){
    //too gg to code without return working properly
     //I worked this out but can't be bothered making it a seperate function.
 }
</script>
</head>
<body>
<nav class="navbar navbar-default">
<!--<form class="form-inline">
    <h4>Feedback here</h4>
    <div class="form-group">
        <label for="femail">Email</label>
        <input type="email" class="form-control" id="femail" placeholder="Monash email...">
    </div>
    <div class="form-group">
        <label for="ffeedback">Feedback</label>
        <textarea type="email" class="form-control" id="ffeedback" placeholder="Your feedback.."></textarea>
    </div>


</form>
    <button type="submit" onclick="submitfeedback()" class="btn btn-default">Send  feedback</button>
</nav>-->

	
<iframe src="https://docs.google.com/a/student.monash.edu/forms/d/e/1FAIpQLSetWParibqSuwUHsOwcPDl3AC1Z7IsZpsshdqqqyT9ApaOpPA/viewform?embedded=true" width="99%" height="350" frameborder="0" marginheight="0" marginwidth="0">Loading...</iframe>
	
	
    <h1>Allocate+ to Calendar</h1>
    <h3>Your text here...</h3>
    <textarea style="height: 12em; width: 75%" placeholder="Copy Paste your csv file" id="csvValues"></textarea>
    <br>
	<div class="checkbox">
	    <label>
		<input type="checkbox" value="" id="clayton-addresses">
		Force Melbourne Time-zone (if not checked it'll use your default timezone)
	    </label>
	</div>
	<button id="submit" onclick="make()">Make .ics</button>

    <h2>Step 1</h2><br>
    Open allocate+ and login
    <br><img src="1.JPG">


    <h2>Step 2</h2><br>
    Click the button shown and export as an excel file
    <br><img src="2.JPG">


    <h2>Step 3</h2><br>
    Open the excel file and get rid of all existing commas using 'find and replace'. Replace it with NO spaces.
    <br><img src="3.JPG">


    <h2>Step 4</h2><br>
    Save it as a CSV file and click yes to all warnings
    <br><img src="4.JPG">


    <h2>Step 5</h2><br>
    Open the csv file using notepad/notepad++/ whatever you feel comfortable with and copy it's contents and paste in the textbox on the website<br>
    DO NOT INCLUDE THE BLANK LAST LINE
    <br><img src="5.JPG">

    <h2>Step 6</h2>
    <br> This generates a .ics file, which can be imported into any calender application. For google calendar follow 
    <a href="https://support.google.com/calendar/answer/37118?hl=en">This guide</a>
</body>

<!--Subject Code	Description	Group	Activity	Day	Time	Campus	Location	Staff	Duration	Dates-->
<!--
Subject Code,Description,Group,Activity,Day,Time,Campus,Location,Staff,Duration,Dates
FIT1045_CL_S1_DAY,ALG PROG FUN PYTHON,Laboratory,12,Thu,18:00,CL,CL_14Rnf/146,-,2 hrs,2/3-13/4 27/4-25/5
FIT1045_CL_S1_DAY,ALG PROG FUN PYTHON,Lecture,02-P2,Tue,13:00,CL,CL_21Col/E3,Aamir Cheema,1 hr,28/2-11/4 25/4-23/5
FIT1045_CL_S1_DAY,ALG PROG FUN PYTHON,Lecture,02-P1,Mon,15:00,CL,CL_21Col/E3,Aamir Cheema,1 hr,27/2-10/4 24/4-22/5
FIT1045_CL_S1_DAY,ALG PROG FUN PYTHON,Tutorial,28,Tue,10:00,CL,CL_7Inn/CG22,-,2 hrs,28/2-11/4 25/4-23/5
FIT1047_CL_S1_DAY,INTRO CSN&SEC,Laboratory,23,Tue,17:00,CL,CL_23Col/G44,-,2 hrs,28/2-11/4 25/4-23/5
FIT1047_CL_S1_DAY,INTRO CSN&SEC,Lecture,01-P2,Wed,16:00,CL,CL_43Rnf/STH1,Guido Tack (1/3-12/4 26/4-24/5) Carsten Rudolph (1/3-12/4 26/4-24/5),1 hr,1/3-12/4 26/4-24/5
FIT1047_CL_S1_DAY,INTRO CSN&SEC,Lecture,01-P1,Tue,14:00,CL,CL_43Rnf/STH1,Guido Tack (28/2-11/4 25/4-23/5) Carsten Rudolph (28/2-11/4 25/4-23/5),1 hr,28/2-11/4 25/4-23/5
MAT1830_CL_S1_DAY,DISC MATH COMPSC,Lecture,01-P2,Thu,12:00,CL,CL_25Exh/C1,-,1 hr,2/3-13/4 27/4-25/5
MAT1830_CL_S1_DAY,DISC MATH COMPSC,Lecture,01-P3,Fri,16:00,CL,CL_25Exh/C1,-,1 hr,3/3-14/4 28/4-26/5
MAT1830_CL_S1_DAY,DISC MATH COMPSC,Lecture,01-P1,Wed,12:00,CL,CL_25Exh/C1,-,1 hr,1/3-12/4 26/4-24/5
MAT1830_CL_S1_DAY,DISC MATH COMPSC,Support-Class,13,Mon,11:30,CL,CL_7Inn/CG10,-,1.5 hrs,6/3-10/4 24/4-22/5
MGF1010_CA_S1_DAY,INTRO TO MGT,Workshop,12,Thu,8:00,CA,CA_N/N202,-,2 hrs,2/3-13/4 27/4-25/5
-->
